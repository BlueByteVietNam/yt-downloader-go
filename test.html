<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YT Downloader Test</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    body { max-width: 640px; margin: 40px auto; padding: 20px; background: #f8fafc; color: #1e293b; }
    h1 { font-size: 1.5rem; margin-bottom: 24px; color: #0f172a; }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: #475569; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; background: #fff; }
    input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    button { width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background 0.2s; }
    button:hover { background: #2563eb; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }

    #status { margin-top: 24px; padding: 16px; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; display: none; }
    #status.show { display: block; }

    .status-header { font-weight: 600; margin-bottom: 8px; }
    .status-info { font-size: 0.9rem; color: #64748b; margin-bottom: 12px; }

    .progress-container { margin: 16px 0; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #64748b; margin-bottom: 4px; }
    .progress { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 100%; background: #3b82f6; transition: width 0.3s ease; border-radius: 4px; }
    .progress-bar.done { background: #22c55e; }

    .detail-progress { margin-top: 12px; display: flex; gap: 16px; font-size: 0.85rem; }
    .detail-item { display: flex; align-items: center; gap: 6px; color: #64748b; }
    .detail-bar { width: 60px; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; }
    .detail-bar-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }

    .error { color: #dc2626; }
    .success { color: #16a34a; }
    .warning { color: #d97706; background: #fef3c7; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; margin-top: 8px; }

    .download-link { margin-top: 16px; }
    .download-link a { display: inline-flex; align-items: center; gap: 8px; background: #22c55e; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; }
    .download-link a:hover { background: #16a34a; }

    #trimFields { display: none; margin-top: 8px; }
    #trimFields.show { display: block; }
    #qualityGroup { display: none; }
    #qualityGroup.show { display: block; }

    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-label input { width: auto; }

    .info-box { background: #eff6ff; border: 1px solid #bfdbfe; padding: 10px 12px; border-radius: 6px; margin-bottom: 16px; font-size: 0.85rem; color: #1e40af; }
  </style>
</head>
<body>
  <h1>YT Downloader Test</h1>

  <div class="form-group">
    <label>YouTube URL</label>
    <input type="text" id="url" placeholder="https://www.youtube.com/watch?v=...">
  </div>

  <div class="row">
    <div class="form-group">
      <label>Platform</label>
      <select id="platform">
        <option value="">Auto</option>
        <option value="ios">iOS</option>
        <option value="android">Android</option>
        <option value="macos">macOS</option>
        <option value="windows">Windows</option>
        <option value="linux">Linux</option>
      </select>
    </div>
    <div class="form-group">
      <label>Type</label>
      <select id="type">
        <option value="video">Video</option>
        <option value="audio">Audio</option>
      </select>
    </div>
  </div>

  <div id="platformInfo" class="info-box" style="display: none;"></div>

  <div class="row">
    <div class="form-group">
      <label>Format</label>
      <select id="format"></select>
    </div>
    <div class="form-group" id="qualityGroup">
      <label>Quality</label>
      <select id="quality">
        <option value="">Auto (Best)</option>
        <option value="2160p">4K (2160p)</option>
        <option value="1440p">1440p</option>
        <option value="1080p">1080p</option>
        <option value="720p">720p</option>
        <option value="480p">480p</option>
        <option value="360p">360p</option>
      </select>
    </div>
  </div>

  <div class="form-group">
    <label>Audio Bitrate</label>
    <select id="bitrate">
      <option value="192k">192 kbps</option>
      <option value="128k">128 kbps</option>
      <option value="320k">320 kbps</option>
      <option value="64k">64 kbps</option>
    </select>
  </div>

  <div class="form-group">
    <label class="checkbox-label">
      <input type="checkbox" id="enableTrim">
      <span>Enable Trim</span>
    </label>
  </div>

  <div id="trimFields">
    <div class="row">
      <div class="form-group">
        <label>Start (seconds)</label>
        <input type="number" id="trimStart" value="0" min="0">
      </div>
      <div class="form-group">
        <label>End (seconds)</label>
        <input type="number" id="trimEnd" value="60" min="1">
      </div>
    </div>
  </div>

  <button id="downloadBtn">Download</button>

  <div id="status">
    <div class="status-header" id="statusTitle"></div>
    <div class="status-info" id="statusInfo"></div>

    <div class="progress-container">
      <div class="progress-label">
        <span id="statusPhase">Downloading...</span>
        <span id="statusPercent">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <div class="detail-progress" id="detailProgress" style="display: none;">
      <div class="detail-item">
        <span>Video:</span>
        <div class="detail-bar"><div class="detail-bar-fill" id="videoProgress"></div></div>
        <span id="videoPercent">0%</span>
      </div>
      <div class="detail-item">
        <span>Audio:</span>
        <div class="detail-bar"><div class="detail-bar-fill" id="audioProgress"></div></div>
        <span id="audioPercent">0%</span>
      </div>
    </div>

    <div id="warningBox" class="warning" style="display: none;"></div>
    <div id="errorBox" class="error" style="display: none;"></div>
    <div id="downloadLink" class="download-link"></div>
  </div>

  <script>
    const API = 'https://api.ytconvert.org';
    let currentJobId = null;
    let pollInterval = null;

    const platformInfo = {
      ios: 'iOS: Max 1080p, H.264 codec, AAC audio',
      android: 'Android: Up to 4K, AV1/VP9/H.264, Opus/AAC',
      macos: 'macOS: Max 1080p, H.264 codec, AAC audio',
      windows: 'Windows: Up to 4K, AV1/VP9/H.264, Opus/AAC',
      linux: 'Linux: Up to 4K, AV1/VP9/H.264, Opus/AAC'
    };

    const videoFormats = ['mp4', 'webm', 'mkv'];
    const audioFormats = ['mp3', 'm4a', 'wav', 'opus', 'flac'];

    // Elements
    const els = {
      url: document.getElementById('url'),
      platform: document.getElementById('platform'),
      platformInfo: document.getElementById('platformInfo'),
      type: document.getElementById('type'),
      format: document.getElementById('format'),
      quality: document.getElementById('quality'),
      qualityGroup: document.getElementById('qualityGroup'),
      bitrate: document.getElementById('bitrate'),
      enableTrim: document.getElementById('enableTrim'),
      trimFields: document.getElementById('trimFields'),
      trimStart: document.getElementById('trimStart'),
      trimEnd: document.getElementById('trimEnd'),
      downloadBtn: document.getElementById('downloadBtn'),
      status: document.getElementById('status'),
      statusTitle: document.getElementById('statusTitle'),
      statusInfo: document.getElementById('statusInfo'),
      statusPhase: document.getElementById('statusPhase'),
      statusPercent: document.getElementById('statusPercent'),
      progressBar: document.getElementById('progressBar'),
      detailProgress: document.getElementById('detailProgress'),
      videoProgress: document.getElementById('videoProgress'),
      audioProgress: document.getElementById('audioProgress'),
      videoPercent: document.getElementById('videoPercent'),
      audioPercent: document.getElementById('audioPercent'),
      warningBox: document.getElementById('warningBox'),
      errorBox: document.getElementById('errorBox'),
      downloadLink: document.getElementById('downloadLink')
    };

    // Platform change
    els.platform.addEventListener('change', () => {
      const p = els.platform.value;
      if (p && platformInfo[p]) {
        els.platformInfo.textContent = platformInfo[p];
        els.platformInfo.style.display = 'block';
      } else {
        els.platformInfo.style.display = 'none';
      }
    });

    // Type change
    els.type.addEventListener('change', () => {
      const isVideo = els.type.value === 'video';
      els.format.innerHTML = '';
      (isVideo ? videoFormats : audioFormats).forEach(f => {
        els.format.innerHTML += `<option value="${f}">${f.toUpperCase()}</option>`;
      });
      els.qualityGroup.classList.toggle('show', isVideo);
    });

    // Trim toggle
    els.enableTrim.addEventListener('change', () => {
      els.trimFields.classList.toggle('show', els.enableTrim.checked);
    });

    // Init
    els.type.dispatchEvent(new Event('change'));

    // Format duration
    function formatDuration(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // Reset status UI
    function resetStatus() {
      els.progressBar.style.width = '0%';
      els.progressBar.classList.remove('done');
      els.statusPhase.textContent = 'Starting...';
      els.statusPercent.textContent = '0%';
      els.detailProgress.style.display = 'none';
      els.videoProgress.style.width = '0%';
      els.audioProgress.style.width = '0%';
      els.videoPercent.textContent = '0%';
      els.audioPercent.textContent = '0%';
      els.warningBox.style.display = 'none';
      els.errorBox.style.display = 'none';
      els.downloadLink.innerHTML = '';
    }

    // Download click
    els.downloadBtn.addEventListener('click', async () => {
      const url = els.url.value.trim();
      if (!url) return alert('Please enter a YouTube URL');

      const body = {
        url,
        output: { type: els.type.value, format: els.format.value },
        audio: { bitrate: els.bitrate.value }
      };

      if (els.platform.value) body.os = els.platform.value;
      if (els.type.value === 'video' && els.quality.value) {
        body.output.quality = els.quality.value;
      }
      if (els.enableTrim.checked) {
        body.trim = {
          start: parseFloat(els.trimStart.value) || 0,
          end: parseFloat(els.trimEnd.value) || 60
        };
      }

      els.downloadBtn.disabled = true;
      els.status.classList.add('show');
      resetStatus();

      try {
        const res = await fetch(`${API}/api/download`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');

        currentJobId = data.id;
        els.statusTitle.textContent = data.title;
        els.statusInfo.textContent = `Duration: ${formatDuration(data.duration)}` +
          (data.selectedQuality ? ` | Quality: ${data.selectedQuality}` : '');

        if (data.qualityChanged && data.qualityChangeReason) {
          els.warningBox.textContent = data.qualityChangeReason;
          els.warningBox.style.display = 'block';
        }

        pollInterval = setInterval(checkStatus, 1000);
      } catch (err) {
        els.errorBox.textContent = err.message;
        els.errorBox.style.display = 'block';
        els.downloadBtn.disabled = false;
      }
    });

    // Check status
    async function checkStatus() {
      if (!currentJobId) return;

      try {
        const res = await fetch(`${API}/api/status/${currentJobId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        // Update progress
        els.progressBar.style.width = `${data.progress}%`;
        els.statusPercent.textContent = `${data.progress}%`;

        // Show detail progress for video downloads
        if (data.detail && (data.detail.video !== undefined || data.detail.audio !== undefined)) {
          els.detailProgress.style.display = 'flex';
          if (data.detail.video !== undefined) {
            els.videoProgress.style.width = `${data.detail.video}%`;
            els.videoPercent.textContent = `${data.detail.video}%`;
          }
          if (data.detail.audio !== undefined) {
            els.audioProgress.style.width = `${data.detail.audio}%`;
            els.audioPercent.textContent = `${data.detail.audio}%`;
          }
        }

        // Status phases
        if (data.status === 'downloading') {
          els.statusPhase.textContent = 'Downloading...';
        } else if (data.status === 'processing') {
          els.statusPhase.textContent = 'Processing (FFmpeg)...';
        } else if (data.status === 'done') {
          clearInterval(pollInterval);
          els.progressBar.style.width = '100%';
          els.progressBar.classList.add('done');
          els.statusPhase.textContent = 'Complete!';
          els.statusPercent.textContent = '100%';

          const filename = data.downloadUrl.split('/').pop();
          els.downloadLink.innerHTML = `<a href="${data.downloadUrl}" download>
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Download ${filename}
          </a>`;
          els.downloadBtn.disabled = false;
        } else if (data.status === 'error') {
          clearInterval(pollInterval);
          els.statusPhase.textContent = 'Error';
          els.errorBox.textContent = data.error;
          els.errorBox.style.display = 'block';
          els.downloadBtn.disabled = false;
        }
      } catch (err) {
        clearInterval(pollInterval);
        els.errorBox.textContent = err.message;
        els.errorBox.style.display = 'block';
        els.downloadBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
